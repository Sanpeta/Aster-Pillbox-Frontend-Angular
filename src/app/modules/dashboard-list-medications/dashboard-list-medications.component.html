<ng-template #toastContainer></ng-template>
<app-loader [isLoading]="loading"></app-loader>
<ng-template #dialogContainer></ng-template>

<div class="medications-container">
	<!-- Header Section -->
	<div class="medications-header">
		<div class="header-content">
			<div class="medications-icon">
				<svg
					width="48"
					height="48"
					viewBox="0 0 24 24"
					fill="currentColor"
				>
					<path
						d="M18,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V4A2,2 0 0,0 18,2M18,20H6V4H18V20M9.5,6A1.5,1.5 0 0,0 8,7.5A1.5,1.5 0 0,0 9.5,9A1.5,1.5 0 0,0 11,7.5A1.5,1.5 0 0,0 9.5,6M14.5,6A1.5,1.5 0 0,0 13,7.5A1.5,1.5 0 0,0 14.5,9A1.5,1.5 0 0,0 16,7.5A1.5,1.5 0 0,0 14.5,6M9.5,10A1.5,1.5 0 0,0 8,11.5A1.5,1.5 0 0,0 9.5,13A1.5,1.5 0 0,0 11,11.5A1.5,1.5 0 0,0 9.5,10M14.5,10A1.5,1.5 0 0,0 13,11.5A1.5,1.5 0 0,0 14.5,13A1.5,1.5 0 0,0 16,11.5A1.5,1.5 0 0,0 14.5,10M9.5,14A1.5,1.5 0 0,0 8,15.5A1.5,1.5 0 0,0 9.5,17A1.5,1.5 0 0,0 11,15.5A1.5,1.5 0 0,0 9.5,14M14.5,14A1.5,1.5 0 0,0 13,15.5A1.5,1.5 0 0,0 14.5,17A1.5,1.5 0 0,0 16,15.5A1.5,1.5 0 0,0 14.5,14Z"
					/>
				</svg>
			</div>
			<div class="header-text">
				<h1 class="header-title">Lista de Medicamentos</h1>
				<p class="header-subtitle">
					Gerencie seus medicamentos e monitore seus tratamentos
				</p>
			</div>
			<div class="header-actions">
				<button
					type="button"
					routerLink="/dashboard/medication"
					class="btn btn-primary"
				>
					<svg
						width="20"
						height="20"
						viewBox="0 0 24 24"
						fill="currentColor"
					>
						<path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
					</svg>
					Adicionar Medicamento
				</button>
			</div>
		</div>
	</div>

	<!-- Main Content -->
	<div class="medications-content">
		<!-- Statistics Cards -->
		<div class="stats-section">
			<div class="stats-grid">
				<div class="stat-card stat-primary">
					<div class="stat-icon">
						<svg
							width="24"
							height="24"
							viewBox="0 0 24 24"
							fill="currentColor"
						>
							<path
								d="M9,12L11,14L15,10L20,15V6H4V18L9,12M6,8A2,2 0 0,1 8,10A2,2 0 0,1 6,12A2,2 0 0,1 4,10A2,2 0 0,1 6,8Z"
							/>
						</svg>
					</div>
					<div class="stat-info">
						<h3 class="stat-label">Total de Medicamentos</h3>
						<p class="stat-value">{{ alarms.length }}</p>
					</div>
				</div>

				<div class="stat-card stat-success">
					<div class="stat-icon">
						<svg
							width="24"
							height="24"
							viewBox="0 0 24 24"
							fill="currentColor"
						>
							<path
								d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"
							/>
						</svg>
					</div>
					<div class="stat-info">
						<h3 class="stat-label">Medicamentos Ativos</h3>
						<p class="stat-value">{{ activeAlarmsCount }}</p>
					</div>
				</div>

				<div class="stat-card stat-warning">
					<div class="stat-icon">
						<svg
							width="24"
							height="24"
							viewBox="0 0 24 24"
							fill="currentColor"
						>
							<path
								d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M7.07,18.28C7.5,17.38 8.12,16.5 8.91,15.77L9.5,16.5C8.73,17.38 8.12,18.5 7.91,19.65C7.58,19.26 7.3,18.78 7.07,18.28M6.72,16.91C6.2,16.41 5.74,15.84 5.36,15.23C5.36,14.55 5.36,13.86 5.36,13.18L6.5,13.18C6.5,13.85 6.5,14.5 6.5,15.18L6.82,15.23C6.78,15.79 6.75,16.35 6.72,16.91Z"
							/>
						</svg>
					</div>
					<div class="stat-info">
						<h3 class="stat-label">Total de Alarmes</h3>
						<p class="stat-value">{{ getAlarmCount() }}</p>
					</div>
				</div>

				<div class="stat-card stat-danger">
					<div class="stat-icon">
						<svg
							width="24"
							height="24"
							viewBox="0 0 24 24"
							fill="currentColor"
						>
							<path
								d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"
							/>
						</svg>
					</div>
					<div class="stat-info">
						<h3 class="stat-label">Medicamentos Inativos</h3>
						<p class="stat-value">{{ inactiveAlarmsCount }}</p>
					</div>
				</div>
			</div>
		</div>

		<!-- Filters Section -->
		<div class="filters-section">
			<div class="filters-grid">
				<div class="search-field">
					<div class="search-icon">
						<svg
							width="20"
							height="20"
							viewBox="0 0 24 24"
							fill="currentColor"
						>
							<path
								d="M15.5,14L20.5,19L19,20.5L14,15.5V14.71L13.73,14.43C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.43,13.73L14.71,14H15.5M9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14Z"
							/>
						</svg>
					</div>
					<input
						type="text"
						class="search-input"
						placeholder="Pesquisar medicamentos..."
						(input)="applySearchFilter($event)"
						[value]="searchTerm"
					/>
				</div>

				<div class="filter-field">
					<select
						class="filter-select"
						(change)="applyStateFilter($event)"
					>
						<option value="all">Todos os status</option>
						<option value="Ativo">Ativo</option>
						<option value="Inativo">Inativo</option>
					</select>
				</div>

				<div class="filter-field">
					<select
						class="filter-select"
						(change)="applyCompartmentFilter($event)"
					>
						<option value="all">Todos os compartimentos</option>
						@for (compartment of getUniqueCompartments(); track
						compartment) {
						<option [value]="compartment">
							Compartimento {{ compartment }}
						</option>
						}
					</select>
				</div>
			</div>
		</div>

		<!-- Medications Table -->
		@if (alarms.length === 0) {
		<div class="empty-state">
			<div class="empty-icon">
				<svg
					width="64"
					height="64"
					viewBox="0 0 24 24"
					fill="currentColor"
				>
					<path
						d="M18,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V4A2,2 0 0,0 18,2M18,20H6V4H18V20M12,7A2,2 0 0,1 14,9A2,2 0 0,1 12,11A2,2 0 0,1 10,9A2,2 0 0,1 12,7M12,13A2,2 0 0,1 14,15A2,2 0 0,1 12,17A2,2 0 0,1 10,15A2,2 0 0,1 12,13Z"
					/>
				</svg>
			</div>
			<h3 class="empty-title">Nenhum medicamento encontrado</h3>
			<p class="empty-subtitle">
				Você ainda não cadastrou nenhum medicamento.
			</p>
			<button
				type="button"
				routerLink="/dashboard/medication"
				class="btn btn-primary"
			>
				<svg
					width="20"
					height="20"
					viewBox="0 0 24 24"
					fill="currentColor"
				>
					<path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
				</svg>
				Adicionar Primeiro Medicamento
			</button>
		</div>
		} @else {
		<div class="table-section">
			<div class="table-container">
				<table class="medications-table">
					<thead class="table-header">
						<tr>
							@for (header of tableHeaders; track $index) {
							<th class="table-th">{{ header }}</th>
							}
						</tr>
					</thead>
					<tbody class="table-body">
						@for (alarm of displayedTableDataAlarms; track $index) {
						<tr class="table-row">
							<td class="table-td">
								<div class="medication-info">
									<div class="medication-avatar">
										{{ alarm.name.charAt(0).toUpperCase() }}
									</div>
									<div class="medication-details">
										<div class="medication-name">
											{{ alarm.name }}
										</div>
									</div>
								</div>
							</td>
							<td class="table-td">
								<div class="alarms-list">
									@for (time of alarm.alarms; track $index) {
									<span class="alarm-badge">
										<svg
											width="12"
											height="12"
											viewBox="0 0 24 24"
											fill="currentColor"
										>
											<path
												d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z"
											/>
										</svg>
										{{ time }}
									</span>
									}
								</div>
							</td>
							<td class="table-td">
								<span class="dose-badge">
									{{ alarm.quantity_will_use }} comp.
								</span>
							</td>
							<td class="table-td">
								<div class="stock-info">
									<div class="stock-bar">
										<div
											class="stock-progress"
											[style.width.%]="
												Math.min(
													(alarm.quantity_compartment /
														30) *
														100,
													100
												)
											"
										></div>
									</div>
									<span class="stock-text">
										{{ alarm.quantity_compartment }}
									</span>
								</div>
							</td>
							<td class="table-td">
								<span class="compartment-badge">
									{{ alarm.compartiment }}
								</span>
							</td>
							<td class="table-td">
								<div class="days-list">
									@for (day of alarm.days_of_week; track
									$index) {
									<span class="day-badge">
										{{ day.substring(0, 3) }}
									</span>
									}
								</div>
							</td>
							<td class="table-td">
								@if (alarm.state === 'Ativo') {
								<span class="status-badge status-active">
									Ativo
								</span>
								} @else {
								<span class="status-badge status-inactive">
									Inativo
								</span>
								}
							</td>
							<td class="table-td">
								<div class="actions-menu">
									<a
										[routerLink]="[
											'/dashboard',
											'update-medication'
										]"
										[queryParams]="{
											compartment: alarm.compartment_id,
											medication: alarm.medication_id,
											alarm: alarm.alarm_id,
											case: alarm.case_id
										}"
										class="action-button action-edit"
									>
										<svg
											width="16"
											height="16"
											viewBox="0 0 24 24"
											fill="currentColor"
										>
											<path
												d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"
											/>
										</svg>
										Editar
									</a>
									<button
										class="action-button action-delete"
										(click)="confirmDelete(alarm)"
									>
										<svg
											width="16"
											height="16"
											viewBox="0 0 24 24"
											fill="currentColor"
										>
											<path
												d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"
											/>
										</svg>
										Remover
									</button>
								</div>
							</td>
						</tr>
						}
					</tbody>
				</table>
			</div>

			<!-- Pagination -->
			<div class="pagination-section">
				<div class="pagination-info">
					<p class="pagination-text">
						Mostrando
						<span class="pagination-highlight">
							{{ (currentPage - 1) * itemsPerPage + 1 }}
						</span>
						a
						<span class="pagination-highlight">
							{{
								Math.min(
									currentPage * itemsPerPage,
									getFilteredAlarms().length
								)
							}}
						</span>
						de
						<span class="pagination-highlight">
							{{ getFilteredAlarms().length }}
						</span>
						resultados
					</p>
				</div>

				<div class="pagination-controls">
					<button
						(click)="prevPage()"
						[disabled]="currentPage === 1"
						class="pagination-button pagination-prev"
					>
						<svg
							width="16"
							height="16"
							viewBox="0 0 24 24"
							fill="currentColor"
						>
							<path
								d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z"
							/>
						</svg>
						Anterior
					</button>

					<div class="pagination-pages">
						@for (page of getPageNumbers(); track page) {
						<button
							(click)="setPage(page)"
							class="pagination-button pagination-page"
							[class.active]="page === currentPage"
						>
							{{ page }}
						</button>
						}
					</div>

					<button
						(click)="nextPage()"
						[disabled]="currentPage === pageCount"
						class="pagination-button pagination-next"
					>
						Próximo
						<svg
							width="16"
							height="16"
							viewBox="0 0 24 24"
							fill="currentColor"
						>
							<path
								d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"
							/>
						</svg>
					</button>
				</div>
			</div>
		</div>
		}
	</div>
</div>
